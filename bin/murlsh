#!/usr/bin/env ruby

require 'fileutils'

def usage
  puts <<-eos
Initialize a murlsh site instance in a web directory.

usage: murlsh DESTINATION_DIRECTORY

eos
end

def ask(prompt, default)
  print "#{prompt} [#{default}] "
  answer = $stdin.gets.strip
  answer = default if answer.empty?
  answer
end

def cp_r_safe(sources, dest, options)
  sources.each do |source|
    new = File.join(dest, File.split(File.expand_path(source)).last)

    if File.directory?(source)
      FileUtils.mkdir_p(new, options)
      cp_r_safe(Dir.entries(source).
        reject { |f| %w{. ..}.include?(f) }.
        map { |f| File.join(source, f) }, new, options)
    else
      answer = if File.exists?(new)
        ask("#{new} exists. Overwrite?", 'n')
      else
        'y'
      end

      FileUtils.copy(source, new, options) if answer == 'y'
    end
  end

end

if ARGV.empty?; usage; exit 1; end

dest_dir = ARGV[0]

cp_r_safe(
  %w{.htaccess config.ru config.yaml plugins/ public/ Rakefile}.map { |x| 
    File.join(File.dirname(__FILE__), '..', x) }, dest_dir, :verbose => true)

FileUtils.mkdir_p('tmp', :verbose => true)

cd_command = File.expand_path(dest_dir) == Dir.pwd ? '' : "cd #{dest_dir}\n"

puts <<eos
Next steps:

#{cd_command}edit config.yaml
rake init
eos
